<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet"
          type="text/css"
          href="styles.css"/>
    <title>Gjestebok - Joakim Lindquister</title>
    <meta name="description" content="Legg igjen en melding i gjesteboken til Joakim Lindquister">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="Gjestebok - Joakim Lindquister">
    <meta property="og:description" content="Legg igjen en melding i gjesteboken">
    <meta property="og:type" content="website">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">
    <nav class="links">
        <div class="link-buttons">
            <div class="box">
                <a href="index.html">ğŸ  Hjem</a>
            </div>
            <div class="box">
                <a href="gjestebok.html" class="active">ğŸ“ Gjestebok</a>
            </div>
            <div class="box">
                <a href="https://github.com/quist" target="_blank">GitHub</a>
            </div>
            <div class="box">
                <a href="https://no.linkedin.com/in/joakim-lindquister-8a037865" target="_blank">LinkedIn</a>
            </div>
            <div class="box">
                <a href="mailto:joakiml@gmail.com">Get in Touch</a>
            </div>
        </div>
    </nav>

    <div class="cards">
        <div class="card guestbook-form-card">
            <h2>âœï¸ Skriv en melding</h2>
            <form id="guestbook-form" class="guestbook-form">
                <div class="form-group">
                    <label for="name">Navn:</label>
                    <input type="text" id="name" name="name" required maxlength="50" placeholder="Ditt navn">
                </div>
                <div class="form-group">
                    <label for="message">Melding:</label>
                    <textarea id="message" name="message" required maxlength="500" rows="4" placeholder="Skriv din melding her..."></textarea>
                </div>
                <!-- Honeypot (skal vÃ¦re tom) -->
                <div style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">
                    <label for="website">Nettsted</label>
                    <input type="text" id="website" name="website" tabindex="-1" autocomplete="off">
                </div>
                <button type="submit" class="submit-btn">ğŸ“ Send melding</button>
            </form>
        </div>

        <div class="card guestbook-messages-card">
            <h2>ğŸ’¬ Meldinger fra gjester</h2>
            <div id="messages-container" class="messages-container">
                <div class="no-messages">
                    <p>Ingen meldinger ennÃ¥. VÃ¦r den fÃ¸rste til Ã¥ skrive! âœ¨</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>Built with âœ¨ and Claude Code</p>
    </footer>
</div>

<script type="module">
// Firebase + Firestore-basert gjestebok
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

class Guestbook {
    constructor() {
        this.form = document.getElementById('guestbook-form');
        this.messagesContainer = document.getElementById('messages-container');
        this.initFirebase();
        this.init();
    }

    initFirebase() {
        // Fyll inn din egen Firebase-konfig fra Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyAnTRBovMt9B2dV-MorT3OQEvji2JFBXrg",
            authDomain: "quister-homepage.firebaseapp.com",
            projectId: "quister-homepage",
            storageBucket: "quister-homepage.appspot.com",
            messagingSenderId: "410861821179",
            appId: "1:410861821179:web:63be3919cbb196665d645e"
        };
        const app = initializeApp(firebaseConfig);
        this.db = getFirestore(app);
        this.messagesRef = collection(this.db, 'guestbookMessages');
    }

    init() {
        this.subscribeToMessages();
        this.form.addEventListener('submit', (e) => this.handleSubmit(e));
    }

    async handleSubmit(e) {
        e.preventDefault();

        const formData = new FormData(this.form);
        const name = (formData.get('name') || '').toString().trim();
        const message = (formData.get('message') || '').toString().trim();
        const honeypot = (formData.get('website') || '').toString().trim();

        if (honeypot) {
            // Bot-indikator, ignorer innsendingen lydlÃ¸st
            return;
        }

        if (!name || !message) {
            alert('Vennligst fyll ut alle feltene');
            return;
        }

        if (name.length > 50 || message.length > 500) {
            alert('Ugyldig lengde pÃ¥ felter');
            return;
        }

        try {
            await addDoc(this.messagesRef, {
                name,
                message,
                createdAt: serverTimestamp()
            });
            this.form.reset();
            this.showSuccessMessage();
        } catch (err) {
            console.error('Kunne ikke lagre melding:', err);
            alert('Kunne ikke lagre meldingen. PrÃ¸v igjen.');
        }
    }

    subscribeToMessages() {
        const q = query(this.messagesRef, orderBy('createdAt', 'desc'));
        onSnapshot(q, (snapshot) => {
            const items = snapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    name: data.name || '',
                    message: data.message || '',
                    timestamp: data.createdAt?.toDate ? data.createdAt.toDate().toISOString() : new Date().toISOString()
                };
            });
            this.renderMessages(items);
        }, (error) => {
            console.error('Feil ved henting av meldinger:', error);
        });
    }

    renderMessages(messages) {
        if (!messages || messages.length === 0) {
            this.messagesContainer.innerHTML = `
                <div class=\"no-messages\">
                    <p>Ingen meldinger ennÃ¥. VÃ¦r den fÃ¸rste til Ã¥ skrive! âœ¨</p>
                </div>
            `;
            return;
        }

        const messagesHtml = messages.map(message => `
            <div class=\"message\" data-id=\"${message.id}\">\n                <div class=\"message-header\">\n                    <span class=\"message-name\">ğŸ‘¤ ${this.escapeHtml(message.name)}</span>\n                    <span class=\"message-date\">${this.formatDate(message.timestamp)}</span>\n                </div>\n                <div class=\"message-content\">\n                    ${this.escapeHtml(message.message)}\n                </div>\n            </div>
        `).join('');

        this.messagesContainer.innerHTML = messagesHtml;
    }

    formatDate(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffDays === 0) {
            return 'I dag ' + date.toLocaleTimeString('no', { hour: '2-digit', minute: '2-digit' });
        } else if (diffDays === 1) {
            return 'I gÃ¥r ' + date.toLocaleTimeString('no', { hour: '2-digit', minute: '2-digit' });
        } else if (diffDays < 7) {
            return diffDays + ' dager siden';
        } else {
            return date.toLocaleDateString('no');
        }
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    showSuccessMessage() {
        const button = this.form.querySelector('.submit-btn');
        const originalText = button.textContent;
        button.textContent = 'âœ… Sendt!';
        button.disabled = true;

        setTimeout(() => {
            button.textContent = originalText;
            button.disabled = false;
        }, 2000);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new Guestbook();
});
</script>
</body>
</html>