<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet"
          type="text/css"
          href="styles.css"/>
    <title>Gjestebok - Joakim Lindquister</title>
    <meta name="description" content="Legg igjen en melding i gjesteboken til Joakim Lindquister">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="Gjestebok - Joakim Lindquister">
    <meta property="og:description" content="Legg igjen en melding i gjesteboken">
    <meta property="og:type" content="website">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📝</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK eller Mock for demo -->
    <script>
        // Mock Firebase implementasjon for demo
        // I produksjon ville dette blitt erstattet med ekte Firebase config
        class MockFirebase {
            constructor() {
                this.data = JSON.parse(localStorage.getItem('mock-firebase-guestbook') || '{}');
                this.listeners = [];
            }
            
            ref(path) {
                return {
                    path: path,
                    push: (data) => {
                        const id = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                        this.data[id] = data;
                        localStorage.setItem('mock-firebase-guestbook', JSON.stringify(this.data));
                        this.notifyListeners();
                        return Promise.resolve();
                    },
                    on: (eventType, callback) => {
                        this.listeners.push(callback);
                        // Kall callback umiddelbart med eksisterende data
                        setTimeout(() => {
                            callback({
                                val: () => Object.keys(this.data).length > 0 ? this.data : null
                            });
                        }, 100);
                    },
                    off: (callback) => {
                        this.listeners = this.listeners.filter(l => l !== callback);
                    }
                };
            }
            
            notifyListeners() {
                this.listeners.forEach(callback => {
                    callback({
                        val: () => Object.keys(this.data).length > 0 ? this.data : null
                    });
                });
            }
        }
        
        // Simuler Firebase globals
        window.mockFirebase = new MockFirebase();
        window.database = window.mockFirebase;
        window.firebaseRef = (db, path) => db.ref(path);
        window.firebasePush = (ref, data) => ref.push(data);
        window.firebaseOnValue = (ref, callback) => ref.on('value', callback);
        window.firebaseOff = (ref, callback) => ref.off(callback);
        
        console.log('🔥 Mock Firebase aktiv - simulerer delt database med localStorage');
    </script>
</head>
<body>
<div class="container">
    <nav class="links">
        <div class="cta-section">
            <p class="cta-text">📝 Velkommen til gjesteboken!</p>
        </div>
        <div class="link-buttons">
            <div class="box">
                <a href="index.html">← Tilbake til hjem</a>
            </div>
        </div>
    </nav>

    <div class="cards">
        <div class="card guestbook-form-card">
            <h2>✍️ Skriv en melding</h2>
            <form id="guestbook-form" class="guestbook-form">
                <div class="form-group">
                    <label for="name">Navn:</label>
                    <input type="text" id="name" name="name" required maxlength="50" placeholder="Ditt navn">
                </div>
                <div class="form-group">
                    <label for="message">Melding:</label>
                    <textarea id="message" name="message" required maxlength="500" rows="4" placeholder="Skriv din melding her..."></textarea>
                </div>
                <button type="submit" class="submit-btn">📝 Send melding</button>
            </form>
        </div>

        <div class="card guestbook-messages-card">
            <h2>💬 Meldinger fra gjester</h2>
            <div id="messages-container" class="messages-container">
                <div class="no-messages">
                    <p>Ingen meldinger ennå. Vær den første til å skrive! ✨</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>Built with ✨ and Claude Code</p>
    </footer>
</div>

<script>
// Gjestebok funksjonalitet
class Guestbook {
    constructor() {
        this.storageKey = 'guestbook-messages';
        this.form = document.getElementById('guestbook-form');
        this.messagesContainer = document.getElementById('messages-container');
        this.useFirebase = false;
        this.messagesRef = null;
        this.firebaseListener = null;
        
        this.init();
    }
    
    async init() {
        // Sjekk om Firebase er tilgjengelig
        await this.initializeFirebase();
        
        this.loadMessages();
        this.form.addEventListener('submit', (e) => this.handleSubmit(e));
    }
    
    async initializeFirebase() {
        try {
            // Vent litt for at Mock Firebase skal laste inn
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (window.database && window.firebaseRef) {
                this.messagesRef = window.firebaseRef(window.database, 'guestbook-messages');
                this.useFirebase = true;
                console.log('✅ Database tilkobling etablert');
                
                // Sett opp realtime listener
                this.setupFirebaseListener();
            } else {
                throw new Error('Database ikke tilgjengelig');
            }
        } catch (error) {
            console.warn('⚠️ Database ikke tilgjengelig, bruker localStorage:', error.message);
            this.useFirebase = false;
        }
    }
    
    setupFirebaseListener() {
        if (this.useFirebase && this.messagesRef) {
            this.firebaseListener = window.firebaseOnValue(this.messagesRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const messages = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    this.renderMessages(messages);
                } else {
                    this.renderMessages([]);
                }
            });
        }
    }
    
    async handleSubmit(e) {
        e.preventDefault();
        
        const formData = new FormData(this.form);
        const name = formData.get('name').trim();
        const message = formData.get('message').trim();
        
        if (!name || !message) {
            alert('Vennligst fyll ut alle feltene');
            return;
        }
        
        const newMessage = {
            name: name,
            message: message,
            timestamp: new Date().toISOString()
        };
        
        try {
            await this.addMessage(newMessage);
            this.form.reset();
            this.showSuccessMessage();
        } catch (error) {
            console.error('Feil ved lagring av melding:', error);
            alert('Kunne ikke sende melding. Prøv igjen senere.');
        }
    }
    
    async addMessage(message) {
        if (this.useFirebase && this.messagesRef) {
            // Lagre til Firebase
            await window.firebasePush(this.messagesRef, message);
        } else {
            // Fallback til localStorage
            const messages = this.getMessages();
            message.id = Date.now();
            messages.unshift(message);
            this.saveMessages(messages);
            this.renderMessages(messages);
        }
    }
    
    getMessages() {
        const stored = localStorage.getItem(this.storageKey);
        return stored ? JSON.parse(stored) : [];
    }
    
    saveMessages(messages) {
        localStorage.setItem(this.storageKey, JSON.stringify(messages));
    }
    
    loadMessages() {
        if (!this.useFirebase) {
            // Hvis Firebase ikke er tilgjengelig, bruk localStorage
            const messages = this.getMessages();
            this.renderMessages(messages);
        }
        // Hvis Firebase brukes, laster den automatisk via listener
    }
    
    renderMessages(messages = null) {
        if (messages === null) {
            messages = this.getMessages();
        }
        
        if (messages.length === 0) {
            this.messagesContainer.innerHTML = `
                <div class="no-messages">
                    <p>Ingen meldinger ennå. Vær den første til å skrive! ✨</p>
                    ${this.useFirebase ? '<p class="database-status">🌐 Delt database aktiv - meldinger deles mellom alle brukere</p>' : '<p class="database-status">💾 Lokal lagring aktiv - meldinger kun synlige for deg</p>'}
                </div>
            `;
            return;
        }
        
        const messagesHtml = messages.map(message => `
            <div class="message" data-id="${message.id}">
                <div class="message-header">
                    <span class="message-name">👤 ${this.escapeHtml(message.name)}</span>
                    <span class="message-date">${this.formatDate(message.timestamp)}</span>
                </div>
                <div class="message-content">
                    ${this.escapeHtml(message.message)}
                </div>
            </div>
        `).join('');
        
        const statusIndicator = this.useFirebase ? 
            '<div class="database-status">🌐 Meldinger deles mellom alle brukere</div>' : 
            '<div class="database-status">💾 Meldinger lagres kun lokalt</div>';
        
        this.messagesContainer.innerHTML = messagesHtml + statusIndicator;
    }
    
    formatDate(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) {
            return 'I dag ' + date.toLocaleTimeString('no', { hour: '2-digit', minute: '2-digit' });
        } else if (diffDays === 1) {
            return 'I går ' + date.toLocaleTimeString('no', { hour: '2-digit', minute: '2-digit' });
        } else if (diffDays < 7) {
            return diffDays + ' dager siden';
        } else {
            return date.toLocaleDateString('no');
        }
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    showSuccessMessage() {
        const button = this.form.querySelector('.submit-btn');
        const originalText = button.textContent;
        button.textContent = '✅ Sendt!';
        button.disabled = true;
        
        setTimeout(() => {
            button.textContent = originalText;
            button.disabled = false;
        }, 2000);
    }
}

// Initialiser gjestebok når siden lastes
document.addEventListener('DOMContentLoaded', () => {
    new Guestbook();
});

// Cleanup ved navigering bort fra siden
window.addEventListener('beforeunload', () => {
    if (window.guestbook && window.guestbook.firebaseListener) {
        window.firebaseOff(window.guestbook.messagesRef, window.guestbook.firebaseListener);
    }
});
</script>
</body>
</html>